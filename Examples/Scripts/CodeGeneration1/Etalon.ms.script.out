VOID TestWithDump Etalon.ms.script.test
 STRING CONST cCompareUtilCmd
  'q:\afc.cmd'
 VOID PROCEDURE Etalon
  ^ IN aLambda
  VOID PROCEDURE DeleteEmptyFile
   STRING IN aFileName
   aFileName
   FileSize
   0
   ==
   ?
   (
    aFileName
    sysutils:FileExists
    ?
    (
     aFileName
     DeleteFile
     DROP
    )
   )
  ; // VOID PROCEDURE DeleteEmptyFile
  
  STRING VAR l_FileName
  STRING VAR l_FileNameOut
  STRING VAR l_OutDir
  VOID PROCEDURE Out
   IN aValue
   g_OutFile
   IsNil
   ?FAIL
   'Файл для вывода не открыт'
   aValue
   ToPrintable
   g_OutFile
   File:WriteLn
  ; // VOID PROCEDURE Out
  
  script:FileName
  l_FileName
  pop:Word:SetValue
  ARRAY [
   l_FileName
   if
    (
     g_EtalonCount
     >
     0
    )
   then
    (
     '.'
     g_EtalonCount
     IntToStr
    )
   '.prn'
  ]
  strings:Cat
  l_FileName
  pop:Word:SetValue
  l_FileName
  l_FileNameOut
  pop:Word:SetValue
  l_FileNameOut
  '.out'
  Cat
  l_FileNameOut
  pop:Word:SetValue
  ARRAY [
   sysutils:GetCurrentDir
   'Etalons'
   l_FileName
  ]
  '\'
  strings:CatSep
  l_FileName
  pop:Word:SetValue
  ARRAY [
   sysutils:GetCurrentDir
   'Out'
  ]
  '\'
  strings:CatSep
  l_OutDir
  pop:Word:SetValue
  l_OutDir
  sysutils:ForceDirectories
  ?ASSURE
  ARRAY [
   'Не удалось создать директорию '
   l_OutDir
  ]
  SaveVarAndDo
  g_OutFile
  (
   l_FileNameOut
   File:OpenWrite
   g_OutFile
   pop:Word:SetValue
   DumpStackTo
   (
    aLambda
    DO
   )
   Out
  )
  if
   (
    l_FileName
    sysutils:FileExists
   )
  then
   BEGIN
    ''
    l_FileName
    l_FileNameOut
    CompareFiles
    !
    ?
    (
     STRING VAR l_Compare
     cCompareUtilCmd
     sysutils:FileExists
     ?ASSURE
     ARRAY [
      'Не найдена утилита сравнения: '
      cCompareUtilCmd
     ]
     ARRAY [
      cCompareUtilCmd
      ' '
      l_FileName
      ' '
      l_FileNameOut
     ]
     strings:Cat
     l_Compare
     pop:Word:SetValue
     l_Compare
     Print
     l_Compare
     WinExec
    )
   END
  else
   BEGIN
    STRING VAR l_OutPath
    l_FileName
    sysutils:ExtractFilePath
    l_OutPath
    pop:Word:SetValue
    if
     (
      l_OutPath
      IsNil
     )
    then
     BEGIN
      sysutils:GetCurrentDir
      l_OutPath
      pop:Word:SetValue
      ARRAY [
       l_OutPath
       l_FileName
      ]
      '\'
      strings:CatSep
      l_FileName
      pop:Word:SetValue
     END
    l_OutPath
    sysutils:ForceDirectories
    ?ASSURE
    ARRAY [
     'Не удалось создать директорию '
     l_OutPath
    ]
    32
    l_FileName
    l_FileNameOut
    CopyFile
   END
  l_FileName
  DeleteEmptyFile
  l_FileNameOut
  DeleteEmptyFile
  INC
  g_EtalonCount
 ; // VOID PROCEDURE Etalon
 
 INTEGER VAR g_EtalonCount
 Etalon.ms.script.test
 DumpElement
 (
  0
  g_EtalonCount
  pop:Word:SetValue
 )
 Etalon
 script:FileName
 Etalon
 (
  1
  3
  +
 )
 Etalon
 'Hello world'
 Etalon
 NOP
 Etalon
 ARRAY [
 ]
 Etalon
 1
; // VOID TestWithDump Etalon.ms.script.test

