VOID TestWithDump Etalon.ms.script.test
 STRING CONST cCompareUtilCmd
  'q:\afc.cmd'
 VOID PROCEDURE Etalon
  ^ IN aLambda
  INC
  g_EtalonLevel
  TRY
   INTEGER VAR l_Level
   BOOLEAN VAR l_SameLevel
   g_EtalonPath
   Array:Count
   l_Level
   pop:Word:SetValue
   l_Level
   g_EtalonLevel
   ==
   l_SameLevel
   pop:Word:SetValue
   SaveVarAndDo
   g_EtalonPath
   (
    aLambda
    Etalon.do
   )
  FINALLY
   DEC
   g_EtalonLevel
  END
 ; // VOID PROCEDURE Etalon
 
 VOID PROCEDURE Etalon.do
  IN aLambda
  STRING CONST cPathSep
   '\'
  VOID PROCEDURE DeleteEmptyFile
   STRING IN aFileName
   aFileName
   FileIsEmpty
   ?
   (
    aFileName
    sysutils:FileExists
    ?
    (
     aFileName
     DeleteFile
     DROP
    )
   )
  ; // VOID PROCEDURE DeleteEmptyFile
  
  BOOLEAN FUNCTION FileIsEmpty
   STRING IN aFileName
   aFileName
   FileSize
   0
   ==
   Result
   pop:Word:SetValue
  ; // BOOLEAN FUNCTION FileIsEmpty
  
  STRING VAR l_CurrentDir
  STRING VAR l_EtalonFileName
  STRING VAR l_FileName
  STRING VAR l_OutDir
  VOID PROCEDURE Out
   IN aValue
   g_OutFile
   IsNil
   ?FAIL
   'Файл для вывода не открыт'
   aValue
   ToPrintable
   g_OutFile
   File:WriteLn
  ; // VOID PROCEDURE Out
  
  script:FileName
  sysutils:ExtractFilePath
  l_CurrentDir
  pop:Word:SetValue
  script:FileName
  sysutils:ExtractFileName
  l_FileName
  pop:Word:SetValue
  if
   (
    l_CurrentDir
    IsNil
   )
  then
   BEGIN
    sysutils:GetCurrentDir
    l_CurrentDir
    pop:Word:SetValue
   END
  ARRAY [
   l_FileName
   if
    (
     g_EtalonLevel
     >
     1
    )
   then
    (
     '.'
     g_EtalonLevel
     IntToStr
    )
   if
    (
     g_EtalonCount
     >
     0
    )
   then
    (
     '.'
     g_EtalonCount
     IntToStr
    )
   '.prn'
  ]
  strings:Cat
  l_FileName
  pop:Word:SetValue
  l_FileName
  l_EtalonFileName
  pop:Word:SetValue
  l_EtalonFileName
  '.etalon'
  Cat
  l_EtalonFileName
  pop:Word:SetValue
  ARRAY [
   l_CurrentDir
   'Etalons'
   l_FileName
  ]
  cPathSep
  strings:CatSep
  l_FileName
  pop:Word:SetValue
  ARRAY [
   l_CurrentDir
   'Out'
  ]
  cPathSep
  strings:CatSep
  l_OutDir
  pop:Word:SetValue
  l_OutDir
  sysutils:ForceDirectories
  ?ASSURE
  ARRAY [
   'Не удалось создать директорию '
   l_OutDir
  ]
  ARRAY [
   l_OutDir
   l_EtalonFileName
  ]
  cPathSep
  strings:CatSep
  l_EtalonFileName
  pop:Word:SetValue
  SaveVarAndDo
  g_OutFile
  (
   l_EtalonFileName
   File:OpenWrite
   g_OutFile
   pop:Word:SetValue
   DumpStackTo
   ARRAY (
    g_EtalonPath
   )
   Out
   DumpStackTo
   (
    aLambda
    DO
   )
   Out
   nil
   g_OutFile
   pop:Word:SetValue
  )
  if
   (
    l_FileName
    sysutils:FileExists
   )
  then
   BEGIN
    ''
    l_FileName
    l_EtalonFileName
    CompareFiles
    !
    ?
    (
     STRING VAR l_Compare
     cCompareUtilCmd
     sysutils:FileExists
     ?ASSURE
     ARRAY [
      'Не найдена утилита сравнения: '
      cCompareUtilCmd
     ]
     ARRAY [
      cCompareUtilCmd
      ' '
      l_FileName
      ' '
      l_EtalonFileName
     ]
     strings:Cat
     l_Compare
     pop:Word:SetValue
     l_Compare
     WinExec
    )
   END
  else
   BEGIN
    32
    l_FileName
    l_EtalonFileName
    CopyFile
   END
  l_FileName
  DeleteEmptyFile
  l_EtalonFileName
  DeleteEmptyFile
  INC
  g_EtalonCount
 ; // VOID PROCEDURE Etalon.do
 
 INTEGER VAR g_EtalonCount
 INTEGER VAR g_EtalonLevel
 ARRAY VAR g_EtalonPath
 FILE VAR g_OutFile
 Etalon.ms.script.test
 DumpElement
 (
  nil
  g_OutFile
  pop:Word:SetValue
 )
 (
  0
  g_EtalonCount
  pop:Word:SetValue
 )
 (
  0
  g_EtalonLevel
  pop:Word:SetValue
 )
 (
  ARRAY [
   0
  ]
  g_EtalonPath
  pop:Word:SetValue
 )
 Etalon
 (
  script:FileName
  sysutils:ExtractFileName
 )
 Etalon
 (
  1
  2
  +
 )
 Etalon
 'Hello world'
 Etalon
 NOP
 Etalon
 ARRAY [
 ]
 Etalon
 1
 Etalon
 'Another string'
 Etalon
 ''
 Etalon
 (
  'Root'
  Etalon
  'Nested1'
  Etalon
  (
   'Nested2'
   Etalon
   'Nested2.1'
   Etalon
   'Nested2.2'
  )
 )
; // VOID TestWithDump Etalon.ms.script.test

